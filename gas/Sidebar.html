<!DOCTYPE html>
<html>
<head>
<base target="_top">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Google Sans', Arial, sans-serif;
    font-size: 13px;
    color: #333;
    background: #f8f9fa;
    overflow-x: hidden;
  }

  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .header {
    background: #1a73e8;
    color: #fff;
    padding: 10px 12px;
    font-size: 14px;
    font-weight: 500;
    position: sticky;
    top: 0;
    z-index: 10;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .header .row-num {
    background: rgba(255,255,255,0.2);
    border-radius: 4px;
    padding: 2px 8px;
    font-size: 12px;
  }

  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
  .status-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    font-weight: bold;
    color: #fff;
  }
  .status-ok { background: #34a853; }
  .status-check { background: #ea4335; }
  .status-compound { background: #fbbc04; color: #333; }
  .status-error { background: #ea4335; }
  .status-unknown { background: #999; }

  /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
  .preview-area {
    background: #fff;
    border-bottom: 1px solid #e0e0e0;
    position: relative;
    min-height: 200px;
  }
  .preview-area iframe,
  .preview-area img {
    width: 100%;
    display: block;
    border: none;
  }
  .preview-area iframe {
    height: 350px;
  }
  .preview-area img {
    max-height: 400px;
    object-fit: contain;
    background: #eee;
  }
  .preview-placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 200px;
    color: #999;
    font-size: 13px;
  }
  .open-link {
    position: absolute;
    top: 6px;
    right: 6px;
    background: rgba(0,0,0,0.5);
    color: #fff;
    text-decoration: none;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
  }
  .open-link:hover { background: rgba(0,0,0,0.7); }

  /* ãƒ‡ãƒ¼ã‚¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .data-section {
    padding: 10px 12px;
  }
  .store-name {
    font-size: 15px;
    font-weight: bold;
    margin-bottom: 6px;
    word-break: break-all;
  }
  .meta-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 3px;
    padding: 3px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  .meta-label {
    color: #666;
    font-size: 11px;
    flex-shrink: 0;
    width: 80px;
  }
  .meta-value {
    text-align: right;
    font-weight: 500;
    word-break: break-all;
    flex: 1;
  }
  .meta-value.amount {
    font-family: 'Roboto Mono', monospace;
  }

  /* ç¨é¡ãƒ†ãƒ¼ãƒ–ãƒ« */
  .tax-table {
    width: 100%;
    margin: 8px 0;
    border-collapse: collapse;
    font-size: 12px;
  }
  .tax-table th {
    background: #f0f0f0;
    padding: 4px 6px;
    text-align: center;
    font-weight: 500;
    font-size: 11px;
  }
  .tax-table td {
    padding: 4px 6px;
    text-align: right;
    border-bottom: 1px solid #f0f0f0;
    font-family: 'Roboto Mono', monospace;
  }
  .tax-table td:first-child {
    text-align: left;
    font-family: inherit;
  }

  /* ãƒ‡ãƒãƒƒã‚° */
  .debug-box {
    background: #fce8e6;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
    padding: 6px 8px;
    margin-top: 8px;
    font-size: 11px;
    color: #c62828;
    word-break: break-all;
  }
  .debug-box.empty {
    background: #e8f5e9;
    border-color: #c8e6c9;
    color: #2e7d32;
  }

  /* ãƒ•ã‚¡ã‚¤ãƒ«å */
  .filename {
    font-size: 10px;
    color: #999;
    margin-top: 6px;
    word-break: break-all;
  }

  /* æ¤œè¨¼çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
  .verify-section {
    padding: 10px 12px;
    border-top: 2px solid #e0e0e0;
  }
  .verify-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .verify-title {
    font-size: 13px;
    font-weight: bold;
    color: #555;
  }
  .verify-score {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: bold;
  }
  .score-high { background: #E8F5E9; color: #2e7d32; }
  .score-mid  { background: #FFF8E1; color: #f57f17; }
  .score-low  { background: #FFEBEE; color: #c62828; }

  .verify-ok {
    background: #E8F5E9;
    border: 1px solid #c8e6c9;
    border-radius: 4px;
    padding: 10px;
    text-align: center;
    color: #2e7d32;
    font-size: 12px;
  }

  .issue-card {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    margin-bottom: 8px;
    overflow: hidden;
  }
  .issue-card.severity-high { border-left: 3px solid #ea4335; }
  .issue-card.severity-medium { border-left: 3px solid #fbbc04; }
  .issue-card.severity-low { border-left: 3px solid #34a853; }

  .issue-head {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 8px;
    background: #fafafa;
    border-bottom: 1px solid #f0f0f0;
  }
  .issue-field {
    font-weight: bold;
    font-size: 12px;
  }
  .issue-confidence {
    font-size: 10px;
    color: #888;
  }
  .issue-body {
    padding: 8px;
  }
  .issue-comparison {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 6px;
    font-size: 12px;
  }
  .issue-old {
    background: #FFEBEE;
    padding: 2px 6px;
    border-radius: 3px;
    text-decoration: line-through;
    color: #c62828;
    word-break: break-all;
  }
  .issue-arrow {
    color: #999;
    flex-shrink: 0;
  }
  .issue-new {
    background: #E8F5E9;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
    color: #2e7d32;
    word-break: break-all;
  }
  .issue-reason {
    font-size: 11px;
    color: #666;
    margin-bottom: 4px;
    line-height: 1.4;
  }
  .issue-evidence {
    font-size: 10px;
    color: #888;
    font-style: italic;
  }
  .issue-actions {
    display: flex;
    gap: 4px;
    padding: 6px 8px;
    border-top: 1px solid #f0f0f0;
    background: #fafafa;
  }
  .btn-apply {
    background: #1a73e8;
    color: #fff;
    border: none;
    padding: 4px 12px;
    border-radius: 3px;
    font-size: 11px;
    cursor: pointer;
  }
  .btn-apply:hover { background: #1557b0; }
  .btn-apply:disabled {
    background: #ccc;
    cursor: default;
  }
  .btn-skip {
    background: #fff;
    color: #666;
    border: 1px solid #ddd;
    padding: 4px 12px;
    border-radius: 3px;
    font-size: 11px;
    cursor: pointer;
  }
  .btn-skip:hover { background: #f5f5f5; }

  .verify-empty {
    color: #999;
    font-size: 12px;
    text-align: center;
    padding: 12px;
  }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
  .loading {
    text-align: center;
    padding: 60px 0;
    color: #999;
  }
  .spinner {
    width: 24px; height: 24px;
    border: 3px solid #e0e0e0;
    border-top-color: #1a73e8;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 10px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="header">
  <span>ãƒ¬ã‚·ãƒ¼ãƒˆç¢ºèª</span>
  <span class="row-num" id="rowNum">--</span>
</div>

<div id="content">
  <div class="loading">
    <div class="spinner"></div>
    ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
  </div>
</div>

<script>
  let lastRow = -1;
  let lastVerificationJSON = '';
  let polling = true;
  let errorCount = 0;
  const MAX_ERRORS = 5;
  const POLL_INTERVAL = 800;

  function poll() {
    if (!polling) return;
    google.script.run
      .withSuccessHandler(onData)
      .withFailureHandler(onError)
      .getSelectedRowData();
  }

  function onData(data) {
    errorCount = 0; // æˆåŠŸã—ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ

    if (!data) {
      if (lastRow !== 0) {
        lastRow = 0;
        lastVerificationJSON = '';
        document.getElementById('rowNum').textContent = '--';
        document.getElementById('content').innerHTML =
          '<div class="loading">ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>';
      }
      scheduleNext();
      return;
    }

    // åŒã˜è¡Œã§ã‚‚æ¤œè¨¼çµæœãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã¯æ›´æ–°ã™ã‚‹
    var currentVerificationJSON = data.verificationJSON || '';
    if (data.row === lastRow && currentVerificationJSON === lastVerificationJSON) {
      scheduleNext();
      return;
    }
    lastRow = data.row;
    lastVerificationJSON = currentVerificationJSON;

    document.getElementById('rowNum').textContent = 'Row ' + data.row;
    render(data);
    scheduleNext();
  }

  function onError(err) {
    console.error(err);
    errorCount++;
    if (errorCount >= MAX_ERRORS) {
      polling = false;
      document.getElementById('content').innerHTML =
        '<div class="loading">' +
          '<div style="color:#ea4335;margin-bottom:12px;">æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ</div>' +
          '<button onclick="reconnect()" style="' +
            'background:#1a73e8;color:#fff;border:none;padding:8px 20px;' +
            'border-radius:4px;cursor:pointer;font-size:13px;">å†æ¥ç¶š</button>' +
        '</div>';
      return;
    }
    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆæœ€å¤§10ç§’ï¼‰
    var delay = Math.min(POLL_INTERVAL * Math.pow(2, errorCount), 10000);
    setTimeout(poll, delay);
  }

  function reconnect() {
    errorCount = 0;
    lastRow = -1;
    polling = true;
    document.getElementById('content').innerHTML =
      '<div class="loading"><div class="spinner"></div>å†æ¥ç¶šä¸­...</div>';
    poll();
  }

  function scheduleNext() {
    setTimeout(poll, POLL_INTERVAL);
  }

  function render(d) {
    // currentRow ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
    window.currentRow = d.row;

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // HAND ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å ´åˆã¯æ‰‹æ›¸ããƒ¢ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    if (d.status === 'HAND') {
      // é€šå¸¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
      document.getElementById('content').style.display = 'none';

      // æ‰‹æ›¸ãã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      document.getElementById('handwrittenSection').style.display = 'block';

      // AIèª­å–çµæœã‚’è¡¨ç¤ºï¼ˆæ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä»˜ãï¼‰
      document.getElementById('handTotalOrig').textContent =
        (d.totalAmount || 0).toLocaleString();
      document.getElementById('handDateOrig').textContent =
        d.date || 'ä¸æ˜';
      document.getElementById('handStoreOrig').textContent =
        d.storeName || 'ä¸æ˜';

      // ç”»åƒURLã‚’è¨­å®šï¼ˆiframeã®ç¢ºå®Ÿãªãƒªãƒ­ãƒ¼ãƒ‰ã®ãŸã‚ã€ä¸€åº¦ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰è¨­å®šï¼‰
      var iframe = document.getElementById('handReceiptImage');
      if (d.imageUrl) {
        iframe.src = '';  // ä¸€åº¦ã‚¯ãƒªã‚¢
        setTimeout(function() {
          iframe.src = d.imageUrl;
          iframe.style.display = 'block';
        }, 10);
      } else {
        iframe.src = '';
        iframe.style.display = 'none';
      }

      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('handTotalAmount').value = '';
      document.getElementById('handTaxable10').value = '';
      document.getElementById('handTax10').value = '';
      document.getElementById('handTaxable8').value = '';
      document.getElementById('handTax8').value = '';

      // è‡ªå‹•è¨ˆç®—ã‚’ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã«
      document.getElementById('autoCalcBreakdown').checked = true;
      document.getElementById('manualBreakdown').style.display = 'none';

      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç·é¡å…¥åŠ›æ¬„ã«
      setTimeout(function() {
        document.getElementById('handTotalAmount').focus();
      }, 100);

      return; // é€šå¸¸ã®è¡¨ç¤ºå‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
    }

    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
    // â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

    // æ‰‹æ›¸ãã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
    document.getElementById('handwrittenSection').style.display = 'none';

    // é€šå¸¸ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    document.getElementById('content').style.display = 'block';

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
    let statusClass = 'status-unknown';
    let statusText = d.status;
    if (d.status.indexOf('OK') !== -1) statusClass = 'status-ok';
    else if (d.status.indexOf('CHECK') !== -1) statusClass = 'status-check';
    else if (d.status.indexOf('COMPOUND') !== -1) statusClass = 'status-compound';
    else if (d.status.indexOf('ERROR') !== -1) statusClass = 'status-error';
    else if (d.status.indexOf('HAND') !== -1) statusClass = 'status-unknown';

    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    let previewHtml = '<div class="preview-placeholder">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸å¯</div>';
    let openLinkHtml = '';
    if (d.fileId) {
      if (d.mimeType && d.mimeType.startsWith('image/')) {
        previewHtml = '<img src="https://drive.google.com/thumbnail?id=' +
          d.fileId + '&sz=w300" alt="receipt">';
      } else {
        // PDFç­‰ã¯iframeãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        previewHtml = '<iframe src="https://drive.google.com/file/d/' +
          d.fileId + '/preview"></iframe>';
      }
      openLinkHtml = '<a class="open-link" href="' + d.fileUrl +
        '" target="_blank">åˆ¥ã‚¿ãƒ–ã§é–‹ã</a>';
    }

    // é‡‘é¡ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    function fmt(v) {
      if (!v && v !== 0) return '-';
      return Number(v).toLocaleString();
    }

    // Debugè¡¨ç¤º
    let debugHtml = '';
    if (d.debug) {
      debugHtml = '<div class="debug-box">' + escHtml(d.debug) + '</div>';
    } else {
      debugHtml = '<div class="debug-box empty">ã‚¨ãƒ©ãƒ¼ãªã—</div>';
    }

    let html = '' +
      '<div class="preview-area">' + previewHtml + openLinkHtml + '</div>' +
      '<div class="data-section">' +
        '<div style="margin-bottom:6px">' +
          '<span class="status-badge ' + statusClass + '">' + escHtml(statusText) + '</span>' +
        '</div>' +
        '<div class="store-name">' + escHtml(d.storeName) + '</div>' +
        '<div class="meta-row">' +
          '<span class="meta-label">æ—¥ä»˜</span>' +
          '<span class="meta-value">' + escHtml(d.date) + '</span>' +
        '</div>' +
        '<div class="meta-row">' +
          '<span class="meta-label">ç™»éŒ²ç•ªå·</span>' +
          '<span class="meta-value">' + escHtml(d.invoiceNumber || '-') + '</span>' +
        '</div>' +
        '<div class="meta-row">' +
          '<span class="meta-label">å‹˜å®šç§‘ç›®</span>' +
          '<span class="meta-value">' + escHtml(d.accountTitle) + ' / ' + escHtml(d.creditAccount) + '</span>' +
        '</div>' +

        '<table class="tax-table">' +
          '<tr><th></th><th>å¯¾è±¡é¡</th><th>æ¶ˆè²»ç¨</th></tr>' +
          '<tr><td>10%</td><td>' + fmt(d.subtotal10) + '</td><td>' + fmt(d.tax10) + '</td></tr>' +
          '<tr><td>8%</td><td>' + fmt(d.subtotal8) + '</td><td>' + fmt(d.tax8) + '</td></tr>' +
          '<tr><td>ä¸èª²ç¨</td><td colspan="2">' + fmt(d.nonTaxable) + '</td></tr>' +
          '<tr style="font-weight:bold;border-top:2px solid #333">' +
            '<td>ç·åˆè¨ˆ</td><td colspan="2">' + fmt(d.totalAmount) + '</td></tr>' +
        '</table>' +

        debugHtml +

        '<div class="filename">' + escHtml(d.fileName) + '</div>' +
      '</div>' +
      renderVerificationSection(d);

    document.getElementById('content').innerHTML = html;
  }

  function renderVerificationSection(d) {
    // æ¤œè¨¼ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°ä½•ã‚‚è¡¨ç¤ºã—ãªã„
    if (!d.verificationJSON) {
      return '';
    }

    var vData;
    try {
      vData = JSON.parse(d.verificationJSON);
    } catch (e) {
      return '';
    }

    var issues = vData.issues || [];
    var score = typeof vData.overallConfidence === 'number' ? vData.overallConfidence : -1;

    // ã‚¹ã‚³ã‚¢ãƒãƒƒã‚¸
    var scoreClass = 'score-high';
    if (score < 0.7) scoreClass = 'score-low';
    else if (score < 0.9) scoreClass = 'score-mid';

    var scoreHtml = score >= 0
      ? '<span class="verify-score ' + scoreClass + '">' + (score * 100).toFixed(0) + '%</span>'
      : '';

    var html = '<div class="verify-section">' +
      '<div class="verify-header">' +
        '<span class="verify-title">AIæ¤œè¨¼çµæœ</span>' +
        scoreHtml +
      '</div>';

    if (issues.length === 0) {
      html += '<div class="verify-ok">å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</div>';
    } else {
      for (var i = 0; i < issues.length; i++) {
        html += renderIssueCard(d.row, issues[i], i);
      }
    }

    // æ‰‹æ›¸ããƒ»è¤‡é›‘ãƒ¬ã‚·ãƒ¼ãƒˆæ³¨è¨˜
    var notes = [];
    if (vData.hasHandwriting) notes.push('æ‰‹æ›¸ãæ–‡å­—ã‚’æ¤œå‡º');
    if (vData.isComplexReceipt) notes.push('è¤‡é›‘ãªãƒ¬ã‚·ãƒ¼ãƒˆï¼ˆè¦å†ç¢ºèªï¼‰');
    if (notes.length > 0) {
      html += '<div style="margin-top:6px;font-size:11px;color:#888;">' +
              notes.join(' / ') + '</div>';
    }

    html += '</div>';
    return html;
  }

  function renderIssueCard(row, issue, idx) {
    var sev = issue.severity || 'medium';
    var conf = typeof issue.confidence === 'number' ? (issue.confidence * 100).toFixed(0) + '%' : '';

    var fieldLabel = {
      'storeName': 'åº—å', 'date': 'æ—¥ä»˜', 'totalAmount': 'ç·åˆè¨ˆ',
      'taxable10': 'å¯¾è±¡é¡(10%)', 'tax10': 'æ¶ˆè²»ç¨(10%)',
      'taxable8': 'å¯¾è±¡é¡(8%)', 'tax8': 'æ¶ˆè²»ç¨(8%)',
      'nonTaxable': 'ä¸èª²ç¨', 'accountTitle': 'å‹˜å®šç§‘ç›®',
      'registrationNumber': 'ç™»éŒ²ç•ªå·', 'amount': 'é‡‘é¡', 'tax': 'ç¨åŒºåˆ†'
    }[issue.field] || issue.field;

    var html = '<div class="issue-card severity-' + sev + '">' +
      '<div class="issue-head">' +
        '<span class="issue-field">' + escHtml(fieldLabel) + '</span>' +
        (conf ? '<span class="issue-confidence">ç¢ºä¿¡åº¦ ' + conf + '</span>' : '') +
      '</div>' +
      '<div class="issue-body">';

    // å€¤ã®æ¯”è¼ƒ
    if (issue.currentValue || issue.correctValue) {
      html += '<div class="issue-comparison">' +
        '<span class="issue-old">' + escHtml(String(issue.currentValue || '')) + '</span>' +
        '<span class="issue-arrow">â†’</span>' +
        '<span class="issue-new">' + escHtml(String(issue.correctValue || '')) + '</span>' +
      '</div>';
    }

    if (issue.reason) {
      html += '<div class="issue-reason">' + escHtml(issue.reason) + '</div>';
    }
    if (issue.evidence) {
      html += '<div class="issue-evidence">' + escHtml(issue.evidence) + '</div>';
    }

    html += '</div>';

    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆä¿®æ­£å€¤ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
    if (issue.correctValue !== undefined && issue.correctValue !== null && issue.field) {
      var btnId = 'btn-apply-' + idx;
      html += '<div class="issue-actions">' +
        '<button class="btn-apply" id="' + btnId + '" onclick="applyFix(' +
          row + ',\'' + escAttr(issue.field) + '\',\'' + escAttr(String(issue.correctValue)) +
          '\',' + idx + ')">ä¿®æ­£ã‚’é©ç”¨</button>' +
        '<button class="btn-skip" onclick="skipIssue(' + idx + ')">ã‚¹ã‚­ãƒƒãƒ—</button>' +
      '</div>';
    }

    html += '</div>';
    return html;
  }

  function applyFix(row, field, value, idx) {
    var btn = document.getElementById('btn-apply-' + idx);
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'é©ç”¨ä¸­...';
    }

    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.success) {
          if (btn) {
            btn.textContent = 'é©ç”¨æ¸ˆã¿';
            btn.style.background = '#34a853';
          }
          // è¡Œãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿ã•ã›ã‚‹ãŸã‚lastRowã‚’ãƒªã‚»ãƒƒãƒˆ
          lastRow = -1;
        } else {
          if (btn) {
            btn.textContent = 'å¤±æ•—';
            btn.style.background = '#ea4335';
            btn.disabled = false;
            setTimeout(function() { btn.textContent = 'ä¿®æ­£ã‚’é©ç”¨'; btn.style.background = ''; }, 2000);
          }
          console.error('ä¿®æ­£å¤±æ•—:', result ? result.message : 'unknown');
        }
      })
      .withFailureHandler(function(err) {
        if (btn) {
          btn.textContent = 'å¤±æ•—';
          btn.style.background = '#ea4335';
          btn.disabled = false;
          setTimeout(function() { btn.textContent = 'ä¿®æ­£ã‚’é©ç”¨'; btn.style.background = ''; }, 2000);
        }
        console.error('ä¿®æ­£ã‚¨ãƒ©ãƒ¼:', err);
      })
      .applyVerificationFix(row, field, value);
  }

  function skipIssue(idx) {
    var card = document.querySelectorAll('.issue-card')[idx];
    if (card) {
      card.style.opacity = '0.4';
      card.querySelector('.issue-actions').innerHTML =
        '<span style="color:#999;font-size:11px;">ã‚¹ã‚­ãƒƒãƒ—æ¸ˆã¿</span>';
    }
  }

  function escAttr(s) {
    if (!s) return '';
    return String(s).replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'&quot;');
  }

  function escHtml(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // é–‹å§‹
  poll();
</script>

<!-- æ‰‹æ›¸ãé ˜åè¨¼ç·¨é›†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰ -->
<div id="handwrittenSection" style="display: none; padding: 20px;">

  <h2 style="color: #FF6B00; border-bottom: 2px solid #FF6B00; padding-bottom: 10px;">
    ğŸ–Šï¸ æ‰‹æ›¸ãé ˜åè¨¼
  </h2>

  <div style="background: #FFF3E0; padding: 15px; border-radius: 8px; margin: 20px 0;">
    <p style="margin: 0; color: #E65100; font-weight: bold;">
      ğŸ“‹ å®Ÿéš›ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’è¦‹ã¦ã€æ­£ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
    </p>
  </div>

  <!-- ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒè¡¨ç¤ºï¼ˆPDF/ç”»åƒã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰ -->
  <div style="margin-bottom: 20px; text-align: center;">
    <div style="background: #f5f5f5; padding: 10px; border-radius: 8px; border: 2px solid #ddd;">
      <iframe
        id="handReceiptImage"
        src=""
        style="width: 100%; height: 400px; border: none; border-radius: 4px; display: block;"
        frameborder="0"
      ></iframe>
    </div>
    <p style="margin: 8px 0 0 0; font-size: 12px; color: #666;">
      ğŸ‘† å®Ÿéš›ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’è¦‹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„
    </p>
  </div>

  <!-- AIèª­å–çµæœ -->
  <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
    <h3 style="margin-top: 0; color: #666;">AIèª­å–çµæœï¼ˆå‚è€ƒï¼‰</h3>
    <div style="font-family: monospace;">
      <div>ç·é¡ï¼š<span id="handTotalOrig" style="font-weight: bold;"></span>å††</div>
      <div>æ—¥ä»˜ï¼š<span id="handDateOrig"></span></div>
      <div>ç™ºè¡Œè€…ï¼š<span id="handStoreOrig"></span></div>
    </div>
  </div>

  <!-- ä¿®æ­£ãƒ•ã‚©ãƒ¼ãƒ  -->
  <div style="background: white; padding: 20px; border: 2px solid #FF6B00; border-radius: 8px;">
    <h3 style="margin-top: 0; color: #FF6B00;">ğŸ“ ä¿®æ­£å…¥åŠ›</h3>

    <!-- ç·é¡ -->
    <div style="margin-bottom: 20px;">
      <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333;">
        ç·é¡ï¼ˆå¿…é ˆï¼‰ <span style="color: red;">*</span>
      </label>
      <input
        type="number"
        id="handTotalAmount"
        placeholder="ä¾‹: 2200"
        style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 4px; box-sizing: border-box;"
      >
    </div>

    <!-- è‡ªå‹•è¨ˆç®—ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
    <div style="margin-bottom: 20px; padding: 15px; background: #E3F2FD; border-radius: 4px;">
      <label style="display: flex; align-items: center; cursor: pointer;">
        <input type="checkbox" id="autoCalcBreakdown" checked style="margin-right: 10px; width: 18px; height: 18px;">
        <span style="font-weight: bold; color: #1976D2;">10%ç¨è¾¼ã¨ã—ã¦è‡ªå‹•è¨ˆç®—</span>
      </label>
      <p style="margin: 8px 0 0 28px; font-size: 12px; color: #666;">
        ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨ã€å†…è¨³ã‚’æ‰‹å‹•å…¥åŠ›ã§ãã¾ã™
      </p>
    </div>

    <!-- æ‰‹å‹•å…¥åŠ›ï¼ˆåˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤ºï¼‰ -->
    <div id="manualBreakdown" style="display: none;">
      <h4 style="color: #666; margin-bottom: 15px;">å†…è¨³ï¼ˆæ‰‹å‹•å…¥åŠ›ï¼‰</h4>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; color: #666;">10%ç¨æŠœ</label>
        <input type="number" id="handTaxable10" placeholder="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; color: #666;">10%ç¨é¡</label>
        <input type="number" id="handTax10" placeholder="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; color: #666;">8%ç¨æŠœ</label>
        <input type="number" id="handTaxable8" placeholder="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
      </div>

      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 5px; color: #666;">8%ç¨é¡</label>
        <input type="number" id="handTax8" placeholder="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
      </div>
    </div>

    <!-- ãƒœã‚¿ãƒ³ -->
    <div style="display: flex; gap: 10px; margin-top: 25px;">
      <button
        onclick="confirmHandwritten()"
        style="flex: 1; padding: 15px; background: #4CAF50; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer;"
      >
        âœ… ç¢ºå®šã—ã¦æ¬¡ã¸
      </button>
      <button
        onclick="skipHandwritten()"
        style="flex: 1; padding: 15px; background: #9E9E9E; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer;"
      >
        â© ã‚¹ã‚­ãƒƒãƒ—
      </button>
    </div>
  </div>

</div>

<script>
let currentRow = -1;

// è‡ªå‹•è¨ˆç®—ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆ¶å¾¡
document.getElementById('autoCalcBreakdown').addEventListener('change', function(e) {
  document.getElementById('manualBreakdown').style.display =
    e.target.checked ? 'none' : 'block';
});

// æ‰‹æ›¸ãé ˜åè¨¼ã®ç¢ºå®š
function confirmHandwritten() {
  const totalAmount = Number(document.getElementById('handTotalAmount').value);

  if (!totalAmount || totalAmount <= 0) {
    alert('ç·é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  const autoCalc = document.getElementById('autoCalcBreakdown').checked;

  let taxable10, tax10, taxable8, tax8, nonTaxable;

  if (autoCalc) {
    // 10%ç¨è¾¼ã¨ã—ã¦è¨ˆç®—
    taxable10 = Math.round(totalAmount / 1.1);
    tax10 = totalAmount - taxable10;
    taxable8 = 0;
    tax8 = 0;
    nonTaxable = 0;
  } else {
    // æ‰‹å‹•å…¥åŠ›
    taxable10 = Number(document.getElementById('handTaxable10').value) || 0;
    tax10 = Number(document.getElementById('handTax10').value) || 0;
    taxable8 = Number(document.getElementById('handTaxable8').value) || 0;
    tax8 = Number(document.getElementById('handTax8').value) || 0;
    nonTaxable = 0;
  }

  // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
  console.log('[confirmHandwritten] currentRow:', window.currentRow);
  console.log('[confirmHandwritten] totalAmount:', totalAmount);

  // currentRow ã®ç¢ºèª
  if (typeof window.currentRow === 'undefined') {
    alert('ã‚¨ãƒ©ãƒ¼: è¡ŒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
    return;
  }

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  const btn = event.target;
  btn.disabled = true;
  btn.textContent = 'å‡¦ç†ä¸­...';

  console.log('[confirmHandwritten] google.script.run ã‚’å‘¼ã³å‡ºã—ã¾ã™...');

  google.script.run
    .withSuccessHandler(function(result) {
      console.log('[confirmHandwritten] Success:', result);
      btn.disabled = false;
      btn.textContent = 'âœ… ç¢ºå®šã—ã¦æ¬¡ã¸';

      if (result.success) {
        alert('ç¢ºå®šã—ã¾ã—ãŸï¼');
        loadNextRow(); // æ¬¡ã®è¡Œã¸
      } else {
        alert('ã‚¨ãƒ©ãƒ¼: ' + (result.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
      }
    })
    .withFailureHandler(function(error) {
      console.log('[confirmHandwritten] Failure:', error);
      btn.disabled = false;
      btn.textContent = 'âœ… ç¢ºå®šã—ã¦æ¬¡ã¸';
      alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    })
    .updateHandReceipt(
      window.currentRow,
      totalAmount,
      taxable10,
      tax10,
      taxable8,
      tax8,
      nonTaxable
    );
}

function skipHandwritten() {
  if (confirm('ã“ã®è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã‹ï¼Ÿ')) {
    loadNextRow();
  }
}

function loadNextRow() {
  // currentRow ãŒæœªå®šç¾©ã®å ´åˆã¯å‡¦ç†ã—ãªã„
  if (typeof window.currentRow === 'undefined') {
    console.log('currentRow ãŒæœªå®šç¾©ã§ã™');
    return;
  }

  // lastRow ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
  lastRow = -1;
  lastVerificationJSON = '';

  // æ¬¡ã®è¡Œã‚’è‡ªå‹•çš„ã«ãƒãƒ¼ãƒªãƒ³ã‚°ã§å–å¾—
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¬¡ã®ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¾ã§å¾…æ©Ÿ
  console.log('æ¬¡ã®è¡Œã‚’å¾…æ©Ÿä¸­...');
}
</script>

</body>
</html>
