# 検証プロンプトの端数値引きルール統一

## 背景

レシートに「端数値引」がある場合、Gemini（読み込み側）とGPT-5（検証側）で解釈が異なっている。

### 例：七輪のレシート

| 項目 | レシート記載 |
|------|-------------|
| 小計（税抜） | ¥7,140 |
| 消費税10% | ¥714 |
| 端数値引 | -¥4 |
| 合計 | ¥7,850 |

### Geminiの処理（現在）

```
税抜: 7,140 - 4 = 7,136円（値引後）
消費税: 714円
合計: 7,136 + 714 = 7,850円 ✓
```

→ 合計が一致するように税抜を調整。**経理実務的に正しい。**

### GPT-5の指摘（現在）

「レシートには税抜7,140円と書いてある。7,136円は間違い。」

→ レシート記載値をそのまま読めば正しいが、**合計と整合しない。**

---

## 問題点

1. 本来OKなのに「⚠️ 税抜10%: 7136 → 7140」と警告が出る
2. 自動承認の判定に悪影響を与える可能性がある
3. 人間の確認コストが増え、本当の問題を見逃しやすくなる
4. 読み込みと検証で「正解」が違うと混乱の元になる

---

## 統一ルール

**「合計金額を絶対正とし、端数値引きは税抜額で調整する」**

- 合計金額（totalAmount）を絶対正とする
- 税抜額 + 消費税 + 不課税 = 合計 が成立していれば正常
- レシートに「端数値引」「値引」「割引」がある場合、税抜額がレシート記載値より数円〜数十円少なくなることがある（これは正常）
- この差異はissueとして報告しない

---

## 実装内容

`Service_Verification.gs` の `buildVerificationPrompt_()` 関数内に以下を追加する。

### 追加する文言

「ステップ3: 差異の判定と修正提案」セクションの「よくある誤読パターン」の後に追加：

```
'【端数値引き・値引きの処理ルール】\n' +
'\n' +
'レシートに「端数値引」「値引」「割引」「クーポン」などがある場合の注意点：\n' +
'\n' +
'1. 合計金額（totalAmount）を絶対正とする\n' +
'2. 税抜額 + 消費税 + 不課税 = 合計 が成立していれば正常\n' +
'3. 税抜額がレシート記載の「課税対象額」より数円〜数十円少ない場合がある\n' +
'   - これは値引き分を税抜額から差し引いているため\n' +
'   - 例：課税対象 ¥7,140 + 税 ¥714 - 値引 ¥4 = 合計 ¥7,850\n' +
'   - この場合、税抜額は 7,140 ではなく 7,136 が正しい\n' +
'\n' +
'4. 以下の場合はissueとして報告しない：\n' +
'   - taxable10/taxable8 がレシート記載値より少ないが、\n' +
'     合計金額が完全一致している場合\n' +
'   - 差額が「端数値引」「値引」等の金額と一致または近い場合\n' +
'\n' +
'5. 逆に、以下の場合はissueとして報告する：\n' +
'   - 合計金額が一致しない場合\n' +
'   - 差額が値引き額と大きく乖離している場合\n' +
'\n'
```

### 挿入位置

`buildVerificationPrompt_()` 内の以下の行の後：

```javascript
'- 「外税」表記の誤解釈（税抜と消費税の取り違え）\n' +
```

この行の後に上記の文言を追加する。

---

## 期待される効果

- 端数値引きがあるレシートで不要な警告が出なくなる
- 自動承認率が向上する
- 人間が確認すべき本当の問題に集中できる
- 読み込み側と検証側のルールが統一される

---

## 実装完了記録

| 日付 | 内容 | 担当 |
|------|------|------|
| | buildVerificationPrompt_() に端数値引きルールを追加 | Claude Code |
