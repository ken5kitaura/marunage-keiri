# 絆パートナーズ税理士法人 - 顧客管理フロー

## 概要

- **顧客コードプレフィックス**: KZ
- **顧客管理シート**: https://docs.google.com/spreadsheets/d/1w8KfoYs6RFjNM6LZvH9qoD5e5Ow_vB6DrztsUF7nKzg/
- **フォルダ**: https://drive.google.com/drive/folders/1Np68bNyn8QDxDSdSJay4CF-sWx7ckJtK

---

## 列構成（新）

| 列 | 名前 | 説明 |
|----|------|------|
| A | line_user_id | LINE ユーザーID |
| B | customer_name | 顧客名 |
| C | folder_id | 領収書フォルダID |
| D | registered_at | 登録日時 |
| E | customer_code | 顧客コード（KZ001など） |
| F | status | ステータス（ドロップダウン） |
| G | email | メールアドレス |
| H | phone | 電話番号 |
| I | memo | メモ |
| J | passbook_folder_id | 通帳フォルダID |
| K | cc_statement_folder_id | クレカ明細フォルダID |
| L | spreadsheet_url | 顧客用スプシURL |
| M | invitation_sent_at | 招待メール送信日時 |

---

## ステータスの意味

| ステータス | 意味 |
|------------|------|
| 未使用 | フォルダ準備済み、顧客未割当 |
| 送信待ち | このステータスに変更すると招待メールが送信される |
| 招待済 | 招待メール送信完了、LINE連携待ち |
| 契約済 | LINE連携完了、領収書受付中 |

---

## フロー

### 1. 初期セットアップ

1. 顧客管理シートを作成
2. GASコードを設定
3. メニュー → `🔧 顧客管理` → `⚙️ 初期セットアップ` を実行
   - 顧客管理シートのヘッダー設定
   - フロー手順シートの自動作成
4. メニュー → `🔧 顧客管理` → `📁 新規フォルダ50件作成（一括）` を実行
   - KZ001〜KZ050 のフォルダ作成
   - 各フォルダに領収書/通帳/クレカ明細サブフォルダ
   - 各顧客用スプシ（ClientConfig付き）
   - サービスアカウントに権限付与
   - ステータス列にドロップダウン設定

---

### 2. 新規顧客の登録（税理士の作業）

1. 顧客管理シートを開く
2. 「未使用」ステータスの行を探す
3. 以下を入力：
   - **B列**: 顧客名
   - **G列**: メールアドレス
4. **F列（ステータス）を「未使用」→「送信待ち」に変更**
5. 自動で招待メールが送信される
6. 送信成功 → ステータスが「招待済」に自動変更

#### エラーの場合
- 顧客名またはメールが未入力 → エラーダイアログ、ステータスは「未使用」に戻る
- 送信失敗 → エラーダイアログ、ステータスは「未使用」に戻る

---

### 3. 顧客がLINE連携する（顧客の作業）

1. 招待メールを受信
2. LINEで公式アカウントを友達追加
3. トーク画面で顧客コード（例: KZ001）を入力
4. 「設定が完了しました」と表示される
5. 顧客管理シートのステータスが「招待済」→「契約済」に自動変更

---

### 4. 領収書・通帳の送信（顧客の作業）

1. LINEで写真を送信
2. 自動で分類されて保存：
   - レシート → 領収書フォルダ
   - 通帳 → 通帳フォルダ
3. 顧客に確認メッセージが返信される

---

### 5. フォルダが足りなくなったら（税理士の作業）

1. メニュー → `🔧 顧客管理` → `📁 新規フォルダ50件作成（一括）`
2. 次の番号から50件自動作成（例: KZ051〜KZ100）

---

## メニュー一覧

| メニュー | 説明 |
|----------|------|
| 📁 新規フォルダ50件作成（一括） | フォルダ/スプシ作成 → 登録 → 権限付与 |
| 📁 フォルダのみ作成 | 任意の件数を作成 |
| 📝 スプシに登録 | 既存フォルダをシートに登録 |
| 🔑 権限付与（全フォルダ） | サービスアカウントに権限付与 |
| 📧 招待メール送信（送信待ち分） | 「送信待ち」ステータスの行に一括送信 |
| 📊 次の顧客コードを確認 | 次に使えるコード番号を表示 |
| ⚙️ 初期セットアップ | ヘッダー設定 + フロー手順シート作成 |

---

## 技術情報

- **GASスクリプトID**: 1rwp_RiQ9pqbL2R8RGniTkrTAXvYDcOvxXPTkNpf_QlLn68vnKdSzKxHA
- **ローカルコード**: ~/Desktop/marunage/gas/customer-management-kizuna/
- **サービスアカウント**: 845322634063-compute@developer.gserviceaccount.com
