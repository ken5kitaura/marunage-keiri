# 実装指示書：自動検証＋自動承認機能（第1弾）

## 背景

Receipt-Engine（GASライブラリ）に、レシートの自動検証・自動承認機能を追加する。
現在は「行を手動で選んでGPT-5検証を実行」しているが、これを「未検証の行をまとめて自動で検証し、条件を満たせば自動でOKにする」仕組みに拡張する。

---

## 開発環境

- **マシン**：MacBook
- **実装担当**：Claude Code
- **ソースコードの場所**：`desktop/Receipt_Manager_v2`
- **デプロイ**：`clasp push` でGASに反映、GitHubにも保存
- **レシート読み込み**：Gemini Flash
- **検証**：GPT-5

---

## 現状の構造（変更しないもの）

### アーキテクチャ
- **Receipt-Engine**：メインのGASライブラリ（ロジックはすべてここ。Claude Codeが実装する対象）
- **顧客用GAS**：Receipt-Engineをライブラリとして読み込み、ラッパー関数で呼び出すだけ
- 顧客側GASへのラッパー関数追加・トリガー設定は人間が手動で対応する（Claude Codeのスコープ外）

### 既存のステータス体系（A列 = 1列目）
- `OK`：Gemini読み取り時点で問題なし
- `CHECK`：整合性に疑問あり
- `ERROR`：基本情報（日付・店名・金額）が欠落
- `COMPOUND`：複合仕訳（入湯税、8%/10%混在など）
- `HAND`：手書きレシート

### 既存の検証関連カラム（17〜20列目）
- 17列目：検証ステータス（🟢🟡🔴🔧 など）
- 18列目：確度スコア（0〜1の数値）
- 19列目：検証で見つかった問題点
- 20列目：修正案JSON

### 既存の検証ロジック
- `Service_Verification.gs` の `verifyOneRow_()` で1行ずつGPT-5検証を実行
- サイドバー（`Sidebar.html`）から修正を適用できる
- メニューに「選択行を検証」がある

---

## 追加する機能

### 1. `runAutoVerification()`

未検証行を一括でGPT-5検証し、条件を満たせば自動でOKに承認する。

#### 対象行の判定ロジック

以下の**すべて**を満たす行が自動検証の対象：

| 条件 | 詳細 |
|------|------|
| A列のステータス | `CHECK` または `ERROR` または `COMPOUND`（※COMPOUNDは条件付き） |
| COMPOUNDの場合 | 12列目（不課税）が **0円の場合のみ** 対象。0円超は対象外（入湯税・宿泊税・ゴルフ場利用税などが絡むため人間確認が必要） |
| 17列目（検証ステータス） | 空欄（まだ検証されていない） |

※ `OK`、`HAND` は対象外。
※ COMPOUNDで不課税が0円 = 単に8%と10%が混在しているだけ（コンビニ等）→ 機械検証OK。

#### 自動承認の3条件（すべて満たした場合のみ）

| 条件 | 基準 |
|------|------|
| 確度スコア | **0.90以上** |
| 合計金額 | **完全一致（差0円）**。税抜＋消費税＝総合計が1円でもズレていたら自動承認しない |
| 重大な問題 | severity: `high` の問題が **ゼロ** |

#### 検証結果の書き込み

**自動承認された場合：**
- A列 → `OK` に変更
- 17列目 → `🤖 自動承認` に変更
- ファイル名 → `[CHK]`/`[ERR]`/`[CMP]` を `[OK]` に変更（Google Drive上のファイル名も変更）
- 行の背景色をリセット（OKの色に合わせる）

**自動承認されなかった場合（条件未達）：**
- A列 → **変更しない**（CHECK/ERROR/COMPOUNDのまま）
- 17列目 → `🟡要確認` に変更
- 18列目 → 確度スコアを記録
- 19列目 → 問題点を記録
- 20列目 → 修正案JSONを記録（あれば）
- ファイル名 → 変更しない

#### 実行時間制限への対応
- GASの実行時間制限（`MAX_EXECUTION_TIME_MS`、現在4分30秒）を考慮する
- 1回の実行で全件処理できない場合は、処理した件数をログに出力し、次回実行時に残りを処理する
- 毎晩1時のトリガーで呼ばれることを想定（日中の作業を邪魔しない）

---

### 2. `approveSelectedRows()`

選択された行を手動で承認する。人間が17列目を見て内容を確認した後に使うボタン。

#### 処理内容
- A列 → `OK` に変更
- 17列目 → `✅ 手動承認` に変更
- ファイル名 → `[CHK]`/`[ERR]`/`[CMP]` を `[OK]` に変更（Google Drive上も）
- 行の背景色をリセット

#### 制約
- 対象はCHECK/ERROR/COMPOUND行のみ（すでにOKの行やHAND行では何もしない）

---

### 3. メニューへの追加

`onOpen()` のメニューに以下を追加：

- **「未検証行を一括検証」** → `runAutoVerification()` を呼ぶ
- **「選択行を承認」** → `approveSelectedRows()` を呼ぶ

---

## 実装しないもの（第2弾以降）

以下は今回のスコープ外。第2弾で実装予定：

- アラート機能（確度低下の検知、メール通知など）
- ダッシュボード（精度推移のグラフ化）
- スポットチェック（ランダムサンプリング）
- 週次分析レポート

---

## 顧客側GAS用ラッパー関数（参考）

以下のラッパー関数を顧客側GASのスクリプトエディタに追加する（人間が手動で対応）：

```javascript
function runAutoVerification() {
  ReceiptEngine.runAutoVerification();
}

function approveSelectedRows() {
  ReceiptEngine.approveSelectedRows();
}
```

トリガー設定（毎晩1時 → `runAutoVerification`）も人間が顧客側で手動設定する。

---

## 注意事項

- 既存の `verifyOneRow_()` のロジックを壊さないこと。新機能はこれを内部で呼び出す形が望ましい
- ファイル名変更は既存の `renameFileOnDrive_()` または同等の処理を使う
- 背景色の設定は既存のステータス別カラーリングの仕組みに合わせる
- ログ出力は十分に行う（何行処理して、何行が自動承認され、何行が要確認になったか）

---

## 実装完了記録

**実装日**：2025年2月5日
**実装者**：Claude Code

### 実装されたもの

| 機能 | ファイル・行 | 内容 |
|------|-------------|------|
| `runAutoVerification()` | `Service_Verification.gs:24-145` | 未検証行の一括検証＋自動承認 |
| `approveSelectedRows()` | `Service_Verification.gs:296-344` | 選択行の手動承認 |
| メニュー追加 | `_Main.gs:27-28` | 「未検証行を一括検証」「選択行を承認」 |

### 新規ヘルパー関数

- `applyApproval_()`：自動承認・手動承認の共通処理
- `renameFilePrefix_()`：Drive上のファイル名プレフィックス変更
- `readVerificationResult_()`：検証結果の読み取り
- `shouldAutoApprove_()`：自動承認3条件の判定

### 設計上のポイント

- 既存の `verifyOneRow_()` のロジックは変更せず、内部で呼び出す形
- `LockService` で多重実行を防止
- タイムアウト時は処理を中断し、次回実行で残りを処理

### 顧客側の対応（人間が手動）

- ラッパー関数2つを顧客側GASに追加済み
- トリガー設定（毎晩1時 → `runAutoVerification`）を顧客側で設定
