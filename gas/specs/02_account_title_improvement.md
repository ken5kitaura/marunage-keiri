# 勘定科目推定の改善

## 背景と課題

### 現状の問題

1. **Amazonと楽天の問題**
   - 現在: `STORE_ACCOUNT_MAP` で `Amazon → 消耗品費` と固定
   - 実際: Amazonで本を買ったら「新聞図書費」、USBケーブルなら「消耗品費」と品目によって異なる
   - 結果: 8割は合ってるが、2割は間違っている

2. **個人名領収書の問題**
   - 「山田太郎」だけの手書き領収書 → 店名から勘定科目が推定できない
   - 現在: 最終的に `消耗品費` にデフォルト設定（_Main.gs:299）
   - 実際: 個人名領収書の9割は飲食店（小料理屋、スナック、居酒屋等）

3. **「消耗品費」問題**
   - 確定した消耗品費（ダイソー→消耗品費）と、推定失敗のデフォルト消耗品費が区別できない
   - 全部同じに見えるので、後から確認すべきものがわからない

### ゴール

**「ぱっと見ておかしくない」を目指す**

- 完璧な正確さは求めない（8割合ってればOK）
- 明らかにおかしい仕訳を防ぐ（スタバ→車両費 ❌）
- 判定できないものは「空欄」にして人間に任せる
- freee/MF/弥生との差別化: 精度競争ではなく「前工程の自動化」

---

## 設計方針

### 基本思想

1. **Geminiに「品名を見て判断」させる**
   - 店名だけでわかるもの → 店名で判断
   - 店名だけでわからないもの（Amazon、楽天、個人名）→ 品名を見て判断
   - Geminiは画像全体を見ているので、品名も読める

2. **「許容リスト」で明らかにおかしいを弾く**
   - 店名ごとに「ありえる勘定科目」のリストを持つ
   - Geminiの提案がリスト外なら警告フラグ

3. **判定できないものは空欄**
   - 無理に埋めない
   - 人間が後から確認して入れる

---

## 実装詳細

### 1. Geminiプロンプトの改善（Service_OCR.gs）

現在のプロンプト（勘定科目部分）:
```
判断の指針（店名・レシート内容から総合的に推定してください）:
- 飲食店・カフェ・コンビニでの飲食 → 会議費
...
```

**変更後:**
```
【勘定科目の推定ルール - 重要】

■ 基本方針
1. まず店名を見て、それで勘定科目が明確にわかればそれで判断
2. 店名だけでわからない場合（Amazon、楽天、個人名など）は、品名・明細を見て判断
3. 品名を見てもわからない場合は、suggestedAccountTitle を null にする

■ 店名だけでわかる例
- スターバックス → 会議費
- ENEOS → 車両費
- ダイソー → 消耗品費
- 高島屋 → 交際費

■ 店名だけでわからない例（品名を見て判断）
- Amazon + USBケーブル → 消耗品費
- Amazon + ビジネス書籍 → 新聞図書費
- Amazon + コーヒー豆 → 会議費（福利厚生費でも可）
- 楽天 + 事務用品 → 消耗品費

■ 個人名のみの領収書
- 肩書きあり（税理士、弁護士、司法書士など）→ 支払報酬料
- 肩書きなし → 飲食店と推定して会議費（または交際費）
  理由: 個人名のみの領収書は9割が小料理屋・スナック・居酒屋等

■ 出力ルール
- 確信がある場合: 許可リストから1つ選んで出力
- 確信がない場合: null を出力（後で人間が判断）
```

### 2. 許容リストの追加（Mapping.js）

新しい定数 `ACCOUNT_TITLE_ALLOWED_MAP` を追加:

```javascript
/**
 * 店名カテゴリごとの「許容される勘定科目」リスト
 * Geminiの提案がこのリスト内なら採用、外なら警告
 * 
 * 目的: 明らかにおかしい仕訳を防ぐ（スタバ→車両費 など）
 */
const ACCOUNT_TITLE_ALLOWED_MAP = {
  // カフェ・コンビニ・飲食店
  "カフェ": ["会議費", "福利厚生費", "交際費"],
  "コンビニ": ["会議費", "福利厚生費", "消耗品費"],
  "飲食店": ["会議費", "交際費", "福利厚生費"],
  
  // ガソリン・車両
  "ガソリンスタンド": ["車両費", "旅費交通費"],
  "駐車場": ["車両費", "旅費交通費"],
  "高速道路": ["車両費", "旅費交通費"],
  
  // 百貨店・贈答
  "百貨店": ["交際費", "消耗品費", "福利厚生費"],
  
  // EC（品名で判断するため許容範囲は広い）
  "EC": ["消耗品費", "新聞図書費", "支払手数料", "広告宣伝費", "会議費", "福利厚生費"],
  
  // 交通
  "交通": ["旅費交通費", "車両費"],
  "宿泊": ["旅費交通費"],
  
  // 個人名（飲食店と推定）
  "個人名": ["会議費", "交際費", "支払報酬料"]
};

/**
 * 店名からカテゴリを判定
 * @param {string} storeName
 * @return {string|null} カテゴリ名
 */
function getStoreCategory_(storeName) {
  const s = String(storeName).toLowerCase();
  
  // カフェ
  if (/starbucks|スターバックス|ドトール|タリーズ|コメダ|カフェ|coffee|珈琲/.test(s)) {
    return "カフェ";
  }
  
  // コンビニ
  if (/セブン|ローソン|ファミリーマート|ファミマ|ミニストップ/.test(s)) {
    return "コンビニ";
  }
  
  // 飲食店
  if (/居酒屋|焼肉|寿司|ラーメン|レストラン|食堂|料理|割烹|バー|酒/.test(s)) {
    return "飲食店";
  }
  
  // ガソリンスタンド
  if (/eneos|出光|コスモ|石油|ガソリン|給油/.test(s)) {
    return "ガソリンスタンド";
  }
  
  // 駐車場
  if (/タイムズ|リパーク|パーキング|駐車/.test(s)) {
    return "駐車場";
  }
  
  // 高速道路
  if (/nexco|首都高|阪神高速|高速|有料道路/.test(s)) {
    return "高速道路";
  }
  
  // 百貨店
  if (/高島屋|大丸|伊勢丹|三越|阪急百貨店|百貨店/.test(s)) {
    return "百貨店";
  }
  
  // EC
  if (/amazon|楽天|ヨドバシ|アスクル|monotaro/.test(s)) {
    return "EC";
  }
  
  // 交通
  if (/タクシー|電鉄|鉄道|jr|新幹線|航空|ana|jal/.test(s)) {
    return "交通";
  }
  
  // 宿泊
  if (/ホテル|hotel|旅館|inn/.test(s)) {
    return "宿泊";
  }
  
  // 個人名判定（カタカナ・漢字のみで、上記にマッチしない）
  if (/^[ぁ-んァ-ヶー一-龠々]+$/.test(storeName) && storeName.length <= 10) {
    // 短い日本語名で他にマッチしない → 個人名の可能性
    return "個人名";
  }
  
  return null;
}
```

### 3. 勘定科目検証ロジックの追加（Logic_Accounting.gs）

`inferAccountTitleFromStore` 関数の戻り値を拡張:

```javascript
/**
 * 店舗名と明細から勘定科目を推定
 * 
 * @return {Object} {
 *   accountTitle: string|null,  // 推定された勘定科目（nullは判定不能）
 *   confidence: 'HIGH'|'MEDIUM'|'LOW'|null,  // 確信度
 *   source: string  // 判定根拠（'STORE_MAP'|'GEMINI'|'DEFAULT'|null）
 * }
 */
```

### 4. _Main.gs のデフォルト処理を変更

現在（299行目付近）:
```javascript
accountTitle: accountTitle || '消耗品費',
```

変更後:
```javascript
accountTitle: accountTitle,  // nullのまま（後で人間が埋める）
accountTitleConfidence: accountTitle ? 'HIGH' : null,  // 新規列（オプション）
```

---

## 出力フォーマットの変更

### スプレッドシート出力

| 列 | 現在 | 変更後 |
|----|------|--------|
| 勘定科目 | 常に値あり（デフォルト消耗品費） | 判定できなければ空欄 |
| 摘要 | 店名のみ | Amazon/楽天の場合は「店名 品名」 |

### 摘要欄の例

| 店名 | 品名（Gemini抽出） | 摘要欄（出力） |
|------|-------------------|---------------|
| Amazon | USBケーブル 3本セット | Amazon USBケーブル 3本セット |
| Amazon | ビジネス書「〇〇の教科書」 | Amazon ビジネス書「〇〇の教科書」 |
| スターバックス | （抽出不要） | スターバックス |
| 山田太郎 | （抽出不要） | 山田太郎 |

---

## 実装ステップ

### Phase 1: Geminiプロンプト改善
1. `Service_OCR.gs` の `buildOCRPrompt_()` を更新
2. 品名ベースの勘定科目推定ルールを追加
3. 個人名領収書の判定ルールを追加

### Phase 2: 許容リストの実装
1. `Mapping.js` に `ACCOUNT_TITLE_ALLOWED_MAP` を追加
2. `getStoreCategory_()` 関数を追加
3. `Logic_Accounting.gs` に許容リストチェック関数を追加

### Phase 3: デフォルト処理の変更
1. `_Main.gs` の勘定科目デフォルト処理を削除
2. 空欄のまま出力するように変更
3. 摘要欄にAmazon/楽天の品名を含める処理を追加

### Phase 4: テスト
1. 既存のテストデータで動作確認
2. Amazon/楽天の領収書でテスト
3. 個人名領収書でテスト

---

## 成功基準

1. **明らかにおかしい仕訳がゼロ**
   - スタバ→車両費 のような明らかなミスがない

2. **判定不能は空欄**
   - 無理にデフォルト値を入れない
   - 空欄=要確認 として人間に任せる

3. **Amazon/楽天は品名で判断**
   - 品名がわかれば適切な科目を提案
   - 品名がわからなければ空欄

4. **個人名は飲食店と推定**
   - 肩書きなしの個人名 → 会議費 or 交際費
   - 肩書きあり → 支払報酬料

---

## 実装完了記録

| 日付 | 内容 | 担当 |
|------|------|------|
| 2026-02-06 | Phase 1: Geminiプロンプト改善 | Claude Code ✅ |
| 2026-02-06 | Phase 2: 許容リスト実装 | Claude Code ✅ |
| 2026-02-06 | Phase 3: デフォルト処理変更 | Claude Code ✅ |
| | Phase 4: テスト | 人間 |
