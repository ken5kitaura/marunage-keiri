# 検証時の欠落フィールド検出ルール

## 背景

GPT-5検証で、既存値が「空」「0」「なし」の場合に、正しく読み取った値があってもissuesに含めないケースが発生した。

### 発生した問題

オーエスドラッグのレシート（混合税率）で：

**1回目の検証**
- `yourReading` には全項目が正しく読み取られている
  - taxable8: 696
  - tax8: 55
  - registrationNumber: T7122001001834
- しかし `issues` には含まれていない
- 結果：taxable10、tax10、店名、日付、総額だけ修正された

**2回目の検証**
- 1回目で修正されなかったtaxable8、tax8、registrationNumberがissuesに含まれた
- 結果：ようやく全項目が揃った

### 問題の原因

GPT-5が「既存値と自分の読み取りが違ったらissueにする」と理解しているが、**既存値が「空」「0」の場合に、それを「欠落」として扱うルールが明確でない**。

---

## 追加するルール

**「既存値が空・0・なしの場合、自分の読み取りに有効な値があればissueとして報告する」**

---

## 実装内容

`Service_Verification.gs` の `buildVerificationPrompt_()` 関数内に以下を追加する。

### 追加する文言

「ステップ2: 既存の読み取り結果と比較する」セクションの「【比較してください】」の前に追加：

```javascript
'【重要】既存値が空・0・なしの場合の扱い\n' +
'\n' +
'既存値が「空」「0」「なし」「null」「UNKNOWN」「PARSE_ERROR」で、\n' +
'あなたの読み取り値が有効な値（数値 > 0、または文字列）の場合：\n' +
'\n' +
'- これは「データ欠落」であり、必ず issues に含めること\n' +
'- severity: high として報告すること\n' +
'- comparison の match は false とすること\n' +
'\n' +
'例：\n' +
'- 既存の taxable8 = 0、あなたの読み取り = 696 → issue（severity: high）\n' +
'- 既存の tax8 = 0、あなたの読み取り = 55 → issue（severity: high）\n' +
'- 既存の registrationNumber = なし、あなたの読み取り = T123... → issue（severity: high）\n' +
'- 既存の storeName = PARSE_ERROR、あなたの読み取り = オーエスドラッグ → issue（severity: high）\n' +
'\n' +
'⚠️ 全てのフィールドについて、既存値と自分の読み取りを比較し、\n' +
'差異があれば漏れなく全て issues に含めてください。\n' +
'1回の検証で全ての問題を検出することが重要です。\n' +
'\n'
```

### 挿入位置

`buildVerificationPrompt_()` 内の以下の行の前：

```javascript
'【比較してください】\n' +
```

この行の直前に上記の文言を追加する。

---

## 期待される効果

- 1回の検証で全ての欠落フィールドが検出される
- 2回検証を実行する必要がなくなる
- 混合税率のレシートでも8%と10%の両方が1回で修正される
- 検証の信頼性と効率が向上する

---

## 実装完了記録

| 日付 | 内容 | 担当 |
|------|------|------|
| | buildVerificationPrompt_() に欠落フィールド検出ルールを追加 | Claude Code |
